<!DOCTYPE html>  <html> <head>   <title>xmlrpc.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="class.html">                 class.js               </a>                                           <a class="source" href="setup.html">                 setup.js               </a>                                           <a class="source" href="xmlrpc.html">                 xmlrpc.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               xmlrpc.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>XML-RPC utilities for node.js</h2>

<ul>
<li><a href="http://lmorchard.com">l.m.orchard</a> / 
<a href="&#x6D;a&#x69;&#x6C;&#116;&#111;:&#108;&#109;&#x6F;&#114;c&#104;&#x61;rd&#64;&#x70;&#111;&#98;&#111;&#x78;&#46;&#x63;&#111;&#x6D;">&#108;&#109;&#x6F;&#114;c&#104;&#x61;rd&#64;&#x70;&#111;&#98;&#111;&#x78;&#46;&#x63;&#111;&#x6D;</a> / 
<a href="http://twitter.com/lmorchard">@lmorchard</a></li>
</ul>

<p>This is a quick-and-dirty library to build and parse <a href="http://www.xmlrpc.com/spec">XML-RPC</a> calls and
responses. I am thoroughly embarrassed by this code and have stolen
liberally from others. But, it seems to work and even passes some nodeunit
tests.</p>

<p>Documentation provided by <a href="http://jashkenas.github.com/docco/">docco</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">util</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;util&#39;</span><span class="p">),</span>
    <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">),</span>
    <span class="nx">xml</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;node-xml&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>XML-RPC method call constructor</h3>

<p>Expects a method name and list of parameters:</p>

<pre><code>var msg = new XMLRPC.Call(
    'test.echo', 
    [ "one", "two", "three" ]
);
var xml = msg.xml();
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">XMLRPCMessage</span> <span class="p">(</span><span class="nx">methodname</span><span class="p">,</span> <span class="nx">params</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">methodname</span> <span class="o">||</span> <span class="s2">&quot;system.listMethods&quot;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span> <span class="o">||</span> <span class="p">[];</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">XMLRPCCall</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>XML-RPC response constructor</h3>

<p>Expects a list of parameters:</p>

<pre><code>var resp = new XMLRPC.Response(
    [ "one", "two", "three" ]
);
var xml = msg.xml();
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">XMLRPCResponse</span> <span class="p">(</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="nx">params</span> <span class="o">||</span> <span class="p">[];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>XML-RPC fault response constructor</h3>

<p>Expects a fault code and message string:</p>

<pre><code>var fault = new XMLRPC.Fault(404, "Method not found");
var xml = msg.xml();
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">XMLRPCFault</span> <span class="p">(</span><span class="nx">fault_code</span><span class="p">,</span> <span class="nx">fault_string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">[{</span>
        <span class="nx">faultString</span><span class="o">:</span> <span class="nx">fault_string</span><span class="p">,</span>
        <span class="nx">faultCode</span><span class="o">:</span> <span class="nx">fault_code</span>
    <span class="p">}];</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>XML-RPC message parser constructor</h3>

<p>This uses node-xml to parse an XML stream into JS data structures.</p>

<pre><code>var parser = new XMLRPC.SaxParser({
    onDone: function (data) {
        // data.method
        // data.params
        // data.is_response
        // data.is_fault
    },
    onError: function (msg) {
        // msg = description of problem
    }
});

parser.parseString(test_xml);
</code></pre>

<p>The parser is fairly liberal, by way of laziness. Premature end of input is
watched for, but no attempt is made to validate the actual structure of the
XML. </p>

<p>As long as elements are arranged in something roughly close to the proper
format, this parser should come up with <em>something</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">XMLRPCSaxParser</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>XML-RPC message parser</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">XMLRPCSaxParser</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h4>Initialize the parser object</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>No options, so far, but maybe someday.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Using SaxParser from <a href="https://github.com/robrighter/node-xml">node-xml</a></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">xml</span><span class="p">.</span><span class="nx">SaxParser</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buildHandler</span><span class="p">());</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This is the data parsed out of the XML.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span> 
            <span class="nx">method</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> 
            <span class="nx">is_response</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">is_fault</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">params</span><span class="o">:</span> <span class="p">[]</span> 
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Flag whether available input has finished.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">finished</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Flag whether parsing has completed successfully</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">complete</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Flag whether the current value being parsed ends up being an implicit string.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Keep track of the stack of open elements</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">element_stack</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Keep a stack of CDATA collected for open elements</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">cdata_stack</span> <span class="o">=</span> <span class="p">[[]];</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Stack of values kept during the course of constructing structs</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">value_stack</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Stack of names kept during the course of constructing structs</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">name_stack</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h4>Parse a string chunk</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">parseString</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Just proxy to the SaxParser method. 
TODO: Maybe someday implement a parseFile?</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parseString</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h4>Signal a finish to parsing</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">finish</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>The flag <code>this.finished</code> serves to debounce this function, which
could be called multiple times: eg, in response to the successful
completion of a document or the end of input (possibly premature).</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">finished</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">$this</span><span class="p">;</span> <span class="p">}</span>
        <span class="nx">$this</span><span class="p">.</span><span class="nx">finished</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>XML parsing is all async, so this needs to be as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">complete</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onDone</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Would an error code be better than an english message here?</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s1">&#39;End of input reached before document complete&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h4>Build the handler for use by the node-xml SaxParser</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">buildHandler</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">$this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">cb</span><span class="p">.</span><span class="nx">onStartDocument</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>No response to document start, since parser state was
established in the constructor. Of course, this means
parsers are not reusable.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>React to the start of elements, detects responses and faults, as
well as initializing a new struct or array in progress.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">cb</span><span class="p">.</span><span class="nx">onStartElementNS</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">uri</span><span class="p">,</span> <span class="nx">namespaces</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Push the current element name onto the stack, along with a
collector for CDATA.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">$this</span><span class="p">.</span><span class="nx">element_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">elem</span><span class="p">);</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">cdata_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">([]);</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Detect a methodResponse.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;methodResponse&#39;</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">is_response</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Detect a response that's a fault.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;fault&#39;</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">is_fault</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Push an empty object onto the stack to collect members</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;struct&#39;</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">({});</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Push an empty array onto the stack to collect values</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;array&#39;</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">([]);</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Assume an implicit string, to begin with.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;value&#39;</span><span class="o">:</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Collect CDATA if we're in an element</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">cb</span><span class="p">.</span><span class="nx">onCharacters</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">chars</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">cdata_stack</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">$this</span><span class="p">.</span><span class="nx">cdata_stack</span><span class="p">[</span><span class="nx">$this</span><span class="p">.</span><span class="nx">cdata_stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">chars</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>React to the end of elements.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">cb</span><span class="p">.</span><span class="nx">onEndElementNS</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">uri</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">cdata</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">cdata_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">(),</span>
                    <span class="nx">last_elem</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">element_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>The end of a call or response means a successful end of parsing, </p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;methodCall&#39;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s1">&#39;methodResponse&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">complete</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Record the method name from CDATA, when encountered.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;methodName&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">cdata</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>The end of a param element or a fault means the current
value on the stack is complete.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;param&#39;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s1">&#39;fault&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Push this member name onto the stack for safekeeping
until a value comes along.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;name&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">name_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cdata</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>The end of a member is where we pick up the last
encountered name and value and stick the pair into the
current struct under construction</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;member&#39;</span><span class="o">:</span>
                        <span class="kd">var</span> <span class="nx">curr_name</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">name_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
                            <span class="nx">curr_value</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">[</span><span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="nx">curr_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">curr_value</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Explicit string, i4, int, and double values are treated the same. 
TODO: Should these be parsed more strictly?
TODO: Lots of repetition here, feels icky.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;string&#39;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s1">&#39;i4&#39;</span><span class="o">:</span> 
                    <span class="k">case</span> <span class="s1">&#39;int&#39;</span><span class="o">:</span>
                    <span class="k">case</span> <span class="s1">&#39;double&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cdata</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Parse a boolean into the JS equivalent.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;boolean&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span> <span class="s1">&#39;true&#39;</span> <span class="o">==</span> <span class="nx">cdata</span> <span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">==</span> <span class="nx">cdata</span> <span class="p">));</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Parse a date from its ISO 8601 representation.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;dateTime.iso8601&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">parseISO8601</span><span class="p">(</span><span class="nx">cdata</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Decode a base64 into its binary form.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;base64&#39;</span><span class="o">:</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                        <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">decodeBase64</span><span class="p">(</span><span class="nx">cdata</span><span class="p">));</span> <span class="k">break</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>The end of a value can mean the end of an implicit
string and also the end of an array item.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="k">case</span> <span class="s1">&#39;value&#39;</span><span class="o">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">$this</span><span class="p">.</span><span class="nx">is_implicit_string</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>No type element found within the value element,
so assume an implicit string.</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cdata</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;data&#39;</span> <span class="o">==</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">element_stack</span><span class="p">[</span><span class="nx">$this</span><span class="p">.</span><span class="nx">element_stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Nested inside a data element, so assume an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="kd">var</span> <span class="nx">curr_value</span> <span class="o">=</span> <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
                            <span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">[</span><span class="nx">$this</span><span class="p">.</span><span class="nx">value_stack</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">curr_value</span><span class="p">);</span>
                        <span class="p">}</span> 
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>React to end of document by calling the onDone handler </p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">cb</span><span class="p">.</span><span class="nx">onEndDocument</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">finish</span><span class="p">();</span>
            <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>React to an error by calling the onError handler </p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">cb</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">$this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
            <span class="p">});</span>

        <span class="p">};</span>

    <span class="p">},</span>

    <span class="nx">EOF</span><span class="o">:</span><span class="kc">null</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h3>XML-RPC message prototype</h3>

<p>You know, I should probably just dump this whole object-oriented thing and
just make the constructors return XML drectly.</p>

<p>Also, building XML with string concatenation makes me feel funny. Maybe do
some array concatenation here, at least? Any good XML composition libs in
node?</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h4>Render XML-RPC message as XML</h4>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">xml</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;\n&quot;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;methodCall&gt;\n&quot;</span><span class="p">;</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;methodName&gt;&quot;</span> <span class="o">+</span> <span class="nx">method</span><span class="o">+</span> <span class="s2">&quot;&lt;/methodName&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;methodResponse&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;params&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;fault&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span><span class="p">)</span> <span class="p">{</span> <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;param&gt;\n&quot;</span><span class="p">;</span> <span class="p">}</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;value&gt;&quot;</span> <span class="o">+</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">getParamXML</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&lt;/value&gt;\n&quot;</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span><span class="p">)</span> <span class="p">{</span> <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/param&gt;\n&quot;</span><span class="p">;</span> <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">is_fault</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/params&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/fault&gt;\n&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/methodCall&gt;&quot;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/methodResponse&gt;&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Again, with the object-oriented stuff that I probably shouldn't bother with.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">XMLRPCCall</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="nx">XMLRPCResponse</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="nx">XMLRPCFault</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Dispatch to generate the XML appropriate for a given data type.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">getParamXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">xml</span><span class="p">,</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">dataTypeOf</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">){</span>
        <span class="k">case</span> <span class="s2">&quot;date&quot;</span><span class="o">:</span>
            <span class="nx">xml</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doDateXML</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;array&quot;</span><span class="o">:</span>
            <span class="nx">xml</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doArrayXML</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;struct&quot;</span><span class="o">:</span>
            <span class="nx">xml</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doStructXML</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;boolean&quot;</span><span class="o">:</span>
            <span class="nx">xml</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doBooleanXML</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="nx">xml</span> <span class="o">=</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doValueXML</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>TODO: This could probably be done better with Underscore.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">dataTypeOf</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">o</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="k">switch</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span>
        <span class="k">case</span> <span class="s2">&quot;number&quot;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">==</span> <span class="nx">o</span><span class="p">)</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;i4&quot;</span><span class="p">;</span>
            <span class="k">else</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;double&quot;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s2">&quot;object&quot;</span><span class="o">:</span>
            <span class="kd">var</span> <span class="nx">con</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">con</span> <span class="o">==</span> <span class="nb">Date</span><span class="p">)</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">con</span> <span class="o">==</span> <span class="nb">Array</span><span class="p">)</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;array&quot;</span><span class="p">;</span>
            <span class="k">else</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;struct&quot;</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doValueXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="s2">&quot;&lt;/&quot;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doBooleanXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="o">==</span><span class="kc">true</span><span class="p">)</span><span class="o">?</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;boolean&gt;&quot;</span> <span class="o">+</span> <span class="nx">value</span> <span class="o">+</span> <span class="s2">&quot;&lt;/boolean&gt;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doDateXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;dateTime.iso8601&gt;&quot;</span><span class="p">;</span>
    <span class="nx">xml</span> <span class="o">+=</span> <span class="nx">dateToISO8601</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/dateTime.iso8601&gt;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doArrayXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;array&gt;&lt;data&gt;\n&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;value&gt;&quot;</span> <span class="o">+</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">getParamXML</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&lt;/value&gt;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/data&gt;&lt;/array&gt;\n&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">doStructXML</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">xml</span> <span class="o">=</span> <span class="s2">&quot;&lt;struct&gt;\n&quot;</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">data</span><span class="p">){</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;member&gt;\n&quot;</span><span class="p">;</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;name&gt;&quot;</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;&lt;/name&gt;\n&quot;</span><span class="p">;</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;value&gt;&quot;</span> <span class="o">+</span> <span class="nx">XMLRPCMessage</span><span class="p">.</span><span class="nx">getParamXML</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;&lt;/value&gt;\n&quot;</span><span class="p">;</span>
        <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/member&gt;\n&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">xml</span> <span class="o">+=</span> <span class="s2">&quot;&lt;/struct&gt;\n&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">xml</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>Decode Base64</h3>

<p>Original Idea &amp; Code by <a href="&#109;&#97;&#x69;&#108;&#116;&#111;:&#116;&#104;&#111;&#x6D;&#97;&#115;&#x40;sa&#x6C;&#x74;&#x73;&#116;o&#x72;&#x6D;&#x2E;&#x6E;&#x65;&#x74;">&#116;&#104;&#111;&#x6D;&#97;&#115;&#x40;sa&#x6C;&#x74;&#x73;&#116;o&#x72;&#x6D;&#x2E;&#x6E;&#x65;&#x74;</a>
from <a href="http://soya.saltstorm.net">Soya.Encode.Base64</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">decodeBase64</span> <span class="p">(</span><span class="nx">sEncoded</span><span class="p">){</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Input must be dividable with 4.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">sEncoded</span> <span class="o">||</span> <span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">sEncoded</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">atob</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">atob</span><span class="p">(</span><span class="nx">sEncoded</span><span class="p">);</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">nBits</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">sDecoded</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">base64</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#39;</span><span class="p">;</span>
    <span class="nx">sEncoded</span> <span class="o">=</span> <span class="nx">sEncoded</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\W|=/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sEncoded</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">){</span>
        <span class="nx">nBits</span> <span class="o">=</span>
            <span class="p">(</span><span class="nx">base64</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>   <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span> <span class="o">|</span>
            <span class="p">(</span><span class="nx">base64</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span>
            <span class="p">(</span><span class="nx">base64</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">6</span> <span class="o">|</span>
             <span class="nx">base64</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
        <span class="nx">sDecoded</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span>
            <span class="p">(</span><span class="nx">nBits</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="nx">nBits</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="nx">nBits</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>not sure if the following statement behaves as supposed under
all circumstances, but tests up til now says it does.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">sDecoded</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sDecoded</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span>
        <span class="p">((</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">61</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span>
        <span class="p">(</span><span class="nx">sEncoded</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">61</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h3>Parse an ISO 8601 date</h3>

<p>Stolen from <a href="http://delete.me.uk/2005/03/iso8601.html">http://delete.me.uk/2005/03/iso8601.html</a>, but tweaked to
account for optional hyphens in dates.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">parseISO8601</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">regexp</span> <span class="o">=</span> <span class="s2">&quot;([0-9]{4})(-?([0-9]{2})(-?([0-9]{2})&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?&quot;</span> <span class="o">+</span> 
        <span class="s2">&quot;(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?&quot;</span><span class="p">;</span>
        
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">regexp</span><span class="p">));</span>

    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setMonth</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setMinutes</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setSeconds</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="p">{</span> <span class="nx">date</span><span class="p">.</span><span class="nx">setMilliseconds</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="s2">&quot;0.&quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">offset</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
        <span class="nx">offset</span> <span class="o">*=</span> <span class="p">((</span><span class="nx">d</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">offset</span> <span class="o">-=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">();</span>
    <span class="nx">time</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">offset</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
    <span class="kd">var</span> <span class="nx">d_out</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="nx">d_out</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">time</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">d_out</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h3>Format a date as ISO 8601</h3>

<p>Stolen from <a href="http://delete.me.uk/2005/03/iso8601.html">http://delete.me.uk/2005/03/iso8601.html</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">dateToISO8601</span> <span class="p">(</span><span class="nx">date_in</span><span class="p">,</span> <span class="nx">format</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* accepted values for the format [1-6]:</span>
<span class="cm">     1 Year:</span>
<span class="cm">       YYYY (eg 1997)</span>
<span class="cm">     2 Year and month:</span>
<span class="cm">       YYYY-MM (eg 1997-07)</span>
<span class="cm">     3 Complete date:</span>
<span class="cm">       YYYY-MM-DD (eg 1997-07-16)</span>
<span class="cm">     4 Complete date plus hours and minutes:</span>
<span class="cm">       YYYY-MM-DDThh:mmTZD (eg 1997-07-16T19:20+01:00)</span>
<span class="cm">     5 Complete date plus hours, minutes and seconds:</span>
<span class="cm">       YYYY-MM-DDThh:mm:ssTZD (eg 1997-07-16T19:20:30+01:00)</span>
<span class="cm">     6 Complete date plus hours, minutes, seconds and a decimal</span>
<span class="cm">       fraction of a second</span>
<span class="cm">       YYYY-MM-DDThh:mm:ss.sTZD (eg 1997-07-16T19:20:30.45+01:00)</span>
<span class="cm">    */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">format</span><span class="p">)</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">date_in</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/([-+])([0-9]{2}):([0-9]{2})/</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">offsetnum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
        <span class="nx">offsetnum</span> <span class="o">*=</span> <span class="p">((</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">date_in</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">offsetnum</span> <span class="o">*</span> <span class="mi">60000</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">zeropad</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">((</span><span class="nx">num</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">num</span><span class="p">;</span> <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="nx">str</span> <span class="o">+=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">());</span> <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;T&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">())</span> <span class="o">+</span>
               <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">secs</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span>
                   <span class="p">((</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;0&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                   <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()));</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">secs</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nx">zeropad</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">());</span> <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="nx">offset</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
<span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Pads a single number with a leading zero. Heh.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">leadingZero</span><span class="p">(</span><span class="nx">n</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="nx">n</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">n</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Kinda wish these were at the top, but here's what the module exports.
TODO: set the exports as these things are defined along the way.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">SaxParser</span><span class="o">:</span> <span class="nx">XMLRPCSaxParser</span><span class="p">,</span>
    <span class="nx">Message</span><span class="o">:</span> <span class="nx">XMLRPCMessage</span><span class="p">,</span>
    <span class="nx">Call</span><span class="o">:</span> <span class="nx">XMLRPCCall</span><span class="p">,</span>
    <span class="nx">Response</span><span class="o">:</span> <span class="nx">XMLRPCResponse</span><span class="p">,</span>
    <span class="nx">Fault</span><span class="o">:</span> <span class="nx">XMLRPCFault</span><span class="p">,</span>
    <span class="nx">dateToISO8601</span><span class="o">:</span> <span class="nx">dateToISO8601</span>
<span class="p">};</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 